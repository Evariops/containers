# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# ------------------------------------------------------------------
# SPDK Container Image — Build, Scan, Sign, Publish
# ------------------------------------------------------------------
name: SPDK

on:
  push:
    branches: [main]
    tags: ["spdk/v*"]
    paths:
      - "images/spdk/**"
      - ".github/workflows/spdk.yml"
  pull_request:
    paths:
      - "images/spdk/**"
      - ".github/workflows/spdk.yml"
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/evariops/spdk

# ── Top-level permissions (least-privilege baseline) ─────────────
permissions:
  contents: read

# ── Cancel superseded runs on the same branch / PR ──────────────
concurrency:
  group: spdk-${{ github.ref }}
  cancel-in-progress: true

# ==================================================================
jobs:
  # ────────────────────────────────────────────────────────────────
  # 1. Lint
  # ────────────────────────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: images/spdk/Dockerfile
          config: images/spdk/.hadolint.yaml

  # ────────────────────────────────────────────────────────────────
  # 2. Build SPDK — amd64 (native runner)
  # ────────────────────────────────────────────────────────────────
  build-amd64:
    needs: lint
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    outputs:
      imageid: ${{ steps.build.outputs.imageid }}
      tag: ${{ steps.tag.outputs.tag }}
      minor_tag: ${{ steps.tag.outputs.minor_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tag suffix
        id: tag
        run: |
          if [[ "$GITHUB_REF" == refs/tags/spdk/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/spdk/}"
            # If tag is 3-part semver (vX.Y.Z), derive floating minor tag (vX.Y)
            if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "minor_tag=${TAG%.*}" >> "$GITHUB_OUTPUT"
            fi
          else
            TAG="sha-${GITHUB_SHA::7}"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Build (amd64)
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: images/spdk
          file: images/spdk/Dockerfile
          platforms: linux/amd64
          push: ${{ startsWith(github.ref, 'refs/tags/') }}
          load: ${{ !startsWith(github.ref, 'refs/tags/') }}
          tags: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-amd64
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:cache-amd64
          cache-to: ${{ github.event_name != 'pull_request' && format('type=registry,ref={0}:cache-amd64,mode=max', env.IMAGE_NAME) || '' }}

      # ── Vulnerability scan (gate — before manifest merge) ─────
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # 0.34.1
        env:
          TRIVY_PLATFORM: linux/amd64
        with:
          image-ref: ${{ startsWith(github.ref, 'refs/tags/') && format('{0}:{1}-amd64', env.IMAGE_NAME, steps.tag.outputs.tag) || steps.build.outputs.imageid }}
          format: "table"
          exit-code: "1"
          severity: "HIGH,CRITICAL"

  # ────────────────────────────────────────────────────────────────
  # 3. Build SPDK — arm64 (native ARM runner, NO QEMU)
  # ────────────────────────────────────────────────────────────────
  build-arm64:
    needs: lint
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tag suffix
        id: tag
        run: |
          if [[ "$GITHUB_REF" == refs/tags/spdk/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/spdk/}"
            # If tag is 3-part semver (vX.Y.Z), derive floating minor tag (vX.Y)
            if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "minor_tag=${TAG%.*}" >> "$GITHUB_OUTPUT"
            fi
          else
            TAG="sha-${GITHUB_SHA::7}"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Build (arm64)
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: images/spdk
          file: images/spdk/Dockerfile
          platforms: linux/arm64
          push: ${{ startsWith(github.ref, 'refs/tags/') }}
          load: ${{ !startsWith(github.ref, 'refs/tags/') }}
          tags: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-arm64
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:cache-arm64
          cache-to: ${{ github.event_name != 'pull_request' && format('type=registry,ref={0}:cache-arm64,mode=max', env.IMAGE_NAME) || '' }}

      # ── Vulnerability scan (gate — before manifest merge) ─────
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # 0.34.1
        env:
          TRIVY_PLATFORM: linux/arm64
        with:
          image-ref: ${{ startsWith(github.ref, 'refs/tags/') && format('{0}:{1}-arm64', env.IMAGE_NAME, steps.tag.outputs.tag) || steps.build.outputs.imageid }}
          format: "table"
          exit-code: "1"
          severity: "HIGH,CRITICAL"

  # ────────────────────────────────────────────────────────────────
  # 4. Multi-arch manifest + Sign + SBOM + Attest
  # ────────────────────────────────────────────────────────────────
  publish:
    needs: [build-amd64, build-arm64]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write       # cosign keyless (Fulcio OIDC)
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      # ── Create multi-arch manifest ────────────────────────────
      - name: Create and push multi-arch manifest
        id: manifest
        env:
          TAG: ${{ needs.build-amd64.outputs.tag }}
          MINOR_TAG: ${{ needs.build-amd64.outputs.minor_tag }}
        run: |
          set -euo pipefail

          # Create versioned manifest from per-arch tags
          docker buildx imagetools create \
            -t "${IMAGE_NAME}:${TAG}" \
            "${IMAGE_NAME}:${TAG}-amd64" \
            "${IMAGE_NAME}:${TAG}-arm64"

          # Floating minor tag (e.g. v26.01 from v26.01.0)
          if [[ -n "${MINOR_TAG}" ]]; then
            docker buildx imagetools create \
              -t "${IMAGE_NAME}:${MINOR_TAG}" \
              "${IMAGE_NAME}:${TAG}-amd64" \
              "${IMAGE_NAME}:${TAG}-arm64"
          fi

          # If this is a release tag, also create sha tag
          if [[ "$GITHUB_REF" == refs/tags/spdk/v* ]]; then
            SHA_TAG="sha-${GITHUB_SHA::7}"
            docker buildx imagetools create \
              -t "${IMAGE_NAME}:${SHA_TAG}" \
              "${IMAGE_NAME}:${TAG}-amd64" \
              "${IMAGE_NAME}:${TAG}-arm64"
          fi

          # Retrieve the manifest digest
          DIGEST=$(docker buildx imagetools inspect "${IMAGE_NAME}:${TAG}" --raw | sha256sum | awk '{print "sha256:"$1}')
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "Manifest digest: ${DIGEST}"

      # ── Cosign: install ───────────────────────────────────────
      - name: Install Cosign
        uses: sigstore/cosign-installer@7e8b541eb2e61bf99390e1afd4be13a184e9ebc5 # v3.10.1

      # ── Cosign: sign image (keyless via Fulcio OIDC) ──────────
      - name: Sign image
        env:
          DIGEST: ${{ steps.manifest.outputs.digest }}
        run: |
          cosign sign --yes "${IMAGE_NAME}@${DIGEST}"

      # ── SBOM generation (SPDX) ───────────────────────────────
      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@17ae1740179002c89186b61233e0f892c3118b11 # v0.23.0
        with:
          image: ${{ env.IMAGE_NAME }}@${{ steps.manifest.outputs.digest }}
          format: spdx-json
          output-file: sbom.spdx.json
          upload-artifact: true
          upload-artifact-retention: 90

      # ── SBOM generation (CycloneDX) ──────────────────────────
      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@17ae1740179002c89186b61233e0f892c3118b11 # v0.23.0
        with:
          image: ${{ env.IMAGE_NAME }}@${{ steps.manifest.outputs.digest }}
          format: cyclonedx-json
          output-file: sbom.cdx.json
          upload-artifact: true
          upload-artifact-retention: 90

      # ── Cosign: attest SBOMs on the image ─────────────────────
      - name: Attest SBOM
        env:
          DIGEST: ${{ steps.manifest.outputs.digest }}
        run: |
          cosign attest --yes \
            --predicate sbom.spdx.json \
            --type spdxjson \
            "${IMAGE_NAME}@${DIGEST}"
          cosign attest --yes \
            --predicate sbom.cdx.json \
            --type cyclonedx \
            "${IMAGE_NAME}@${DIGEST}"
